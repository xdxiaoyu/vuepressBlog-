<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>对Vue中的MVVM原理解析和实现 | 小羽</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/xiaoyu_blog/favicon.ico">
    <script language="javascript" type="text/javascript" src="/xiaoyu_blog/js/mouseClick.js"></script>
    <meta name="description" content="此心光明，亦复何言">
    <link rel="preload" href="/xiaoyu_blog/assets/css/0.styles.1e167897.css" as="style"><link rel="preload" href="/xiaoyu_blog/assets/js/app.50625546.js" as="script"><link rel="preload" href="/xiaoyu_blog/assets/js/2.ddd0c7b1.js" as="script"><link rel="preload" href="/xiaoyu_blog/assets/js/10.8de8f570.js" as="script"><link rel="prefetch" href="/xiaoyu_blog/assets/js/11.4943310c.js"><link rel="prefetch" href="/xiaoyu_blog/assets/js/12.09c2d5b0.js"><link rel="prefetch" href="/xiaoyu_blog/assets/js/13.5af0d87d.js"><link rel="prefetch" href="/xiaoyu_blog/assets/js/14.8566b7eb.js"><link rel="prefetch" href="/xiaoyu_blog/assets/js/15.492d0d89.js"><link rel="prefetch" href="/xiaoyu_blog/assets/js/16.c36f3c8b.js"><link rel="prefetch" href="/xiaoyu_blog/assets/js/17.b774721c.js"><link rel="prefetch" href="/xiaoyu_blog/assets/js/18.ee4dbab3.js"><link rel="prefetch" href="/xiaoyu_blog/assets/js/19.d1ba528e.js"><link rel="prefetch" href="/xiaoyu_blog/assets/js/3.40021c4d.js"><link rel="prefetch" href="/xiaoyu_blog/assets/js/4.f207db3b.js"><link rel="prefetch" href="/xiaoyu_blog/assets/js/5.0ef5542d.js"><link rel="prefetch" href="/xiaoyu_blog/assets/js/6.072ac68f.js"><link rel="prefetch" href="/xiaoyu_blog/assets/js/7.622e689f.js"><link rel="prefetch" href="/xiaoyu_blog/assets/js/8.92e32dc3.js"><link rel="prefetch" href="/xiaoyu_blog/assets/js/9.f553a377.js">
    <link rel="stylesheet" href="/xiaoyu_blog/assets/css/0.styles.1e167897.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/xiaoyu_blog/" class="home-link router-link-active"><!----> <span class="site-name">小羽</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/xiaoyu_blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language" class="dropdown-title"><span class="title">Language</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoyu_blog/Language/ES6/" class="nav-link">
  ES6
</a></li><li class="dropdown-item"><!----> <a href="/xiaoyu_blog/Language/ES7-10/" class="nav-link">
  ES7-10
</a></li><li class="dropdown-item"><!----> <a href="/xiaoyu_blog/Language/Node/Node/" class="nav-link">
  Node
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Guide" class="dropdown-title"><span class="title">Guide</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoyu_blog/Guide/Vue/Vue_mvvm/" class="nav-link router-link-exact-active router-link-active">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/xiaoyu_blog/Guide/Axios/" class="nav-link">
  Axios
</a></li><li class="dropdown-item"><!----> <a href="/xiaoyu_blog/Guide/SSO/" class="nav-link">
  SSO
</a></li><li class="dropdown-item"><!----> <a href="/xiaoyu_blog/Guide/Git/" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/xiaoyu_blog/Guide/Webpack/" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/xiaoyu_blog/Guide/Webpack2.0/" class="nav-link">
  Webpack2.0
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label=" Contact" class="dropdown-title"><span class="title"> Contact</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/dingxingxing" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.cnblogs.com/dingxingxing" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客园
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/xiaoyu_blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language" class="dropdown-title"><span class="title">Language</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoyu_blog/Language/ES6/" class="nav-link">
  ES6
</a></li><li class="dropdown-item"><!----> <a href="/xiaoyu_blog/Language/ES7-10/" class="nav-link">
  ES7-10
</a></li><li class="dropdown-item"><!----> <a href="/xiaoyu_blog/Language/Node/Node/" class="nav-link">
  Node
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Guide" class="dropdown-title"><span class="title">Guide</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/xiaoyu_blog/Guide/Vue/Vue_mvvm/" class="nav-link router-link-exact-active router-link-active">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/xiaoyu_blog/Guide/Axios/" class="nav-link">
  Axios
</a></li><li class="dropdown-item"><!----> <a href="/xiaoyu_blog/Guide/SSO/" class="nav-link">
  SSO
</a></li><li class="dropdown-item"><!----> <a href="/xiaoyu_blog/Guide/Git/" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/xiaoyu_blog/Guide/Webpack/" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/xiaoyu_blog/Guide/Webpack2.0/" class="nav-link">
  Webpack2.0
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label=" Contact" class="dropdown-title"><span class="title"> Contact</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/dingxingxing" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.cnblogs.com/dingxingxing" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客园
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Language </span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Guide </span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Vue</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/xiaoyu_blog/Guide/Vue/Vue_mvvm/" class="active sidebar-link">对Vue中的MVVM原理解析和实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/xiaoyu_blog/Guide/Vue/Vue_mvvm/#_1、思路整理" class="sidebar-link">1、思路整理</a></li><li class="sidebar-sub-header"><a href="/xiaoyu_blog/Guide/Vue/Vue_mvvm/#_2、实现" class="sidebar-link">2、实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/xiaoyu_blog/Guide/Vue/Vue_mvvm/#_1、实现html页面" class="sidebar-link">1、实现html页面</a></li><li class="sidebar-sub-header"><a href="/xiaoyu_blog/Guide/Vue/Vue_mvvm/#_2、实现解析器和观察者" class="sidebar-link">2、实现解析器和观察者</a></li><li class="sidebar-sub-header"><a href="/xiaoyu_blog/Guide/Vue/Vue_mvvm/#_3、实现数据劫持监听" class="sidebar-link">3、实现数据劫持监听</a></li></ul></li><li class="sidebar-sub-header"><a href="/xiaoyu_blog/Guide/Vue/Vue_mvvm/#_3、总结" class="sidebar-link">3、总结</a></li></ul></li><li><a href="/xiaoyu_blog/Guide/Vue/Vuex/" class="sidebar-link">Vuex原理解析</a></li><li><a href="/xiaoyu_blog/Guide/Vue/Vue_base/" class="sidebar-link">Vue必会基础</a></li></ul></section></li><li><a href="/xiaoyu_blog/Guide/Axios/" class="sidebar-link">Axios</a></li><li><a href="/xiaoyu_blog/Guide/SSO/" class="sidebar-link">SSO</a></li><li><a href="/xiaoyu_blog/Guide/Git/" class="sidebar-link">Git</a></li><li><a href="/xiaoyu_blog/Guide/Webpack/" class="sidebar-link">Webpack</a></li><li><a href="/xiaoyu_blog/Guide/Webpack2.0/" class="sidebar-link">Webpack</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="对vue中的mvvm原理解析和实现"><a href="#对vue中的mvvm原理解析和实现" class="header-anchor">#</a> 对Vue中的MVVM原理解析和实现</h1> <div class="language-tips extra-class"><pre class="language-text"><code>首先你对Vue需要有一定的了解，知道MVVM。这样才能更有助于你顺利的完成下面原理的阅读学习和编写
</code></pre></div><blockquote><p>下面由我阿巴阿巴的详细走一遍Vue中MVVM原理的实现，这篇文章大家可以学习到：</p> <p>1.Vue数据双向绑定核心代码模块以及实现原理</p> <p>2.订阅者-发布者模式是如何做到让数据驱动视图、视图驱动数据再驱动视图</p> <p>3.如何对元素节点上的指令进行解析并且关联订阅者实现视图更新</p></blockquote> <h2 id="_1、思路整理"><a href="#_1、思路整理" class="header-anchor">#</a> 1、思路整理</h2> <p>实现的流程图：</p> <p><img src="https://img-blog.csdnimg.cn/20190104151402821.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2R3ZnJvc3Q=,size_16,color_FFFFFF,t_70" alt="mvvm"></p> <p>我们要实现一个类MVVM简单版本的Vue框架,就需要实现一下几点：</p> <p>1、实现一个数据监听Observer，对数据对象的所有属性进行监听，数据发生变化可以获取到最新值通知订阅者。</p> <p>2、实现一个解析器Compile解析页面节点指令，初始化视图。</p> <p>3、实现一个观察者Watcher，订阅数据变化同时绑定相关更新函数。并且将自己放入观察者集合Dep中。Dep是Observer和Watcher的桥梁，数据改变通知到Dep，然后Dep通知相应的Watcher去更新视图。</p> <h2 id="_2、实现"><a href="#_2、实现" class="header-anchor">#</a> 2、实现</h2> <p><strong>以下采用ES6的写法，比较简洁，所以大概在300多行代码实现了一个简单的MVVM框架</strong>。</p> <h3 id="_1、实现html页面"><a href="#_1、实现html页面" class="header-anchor">#</a> 1、实现html页面</h3> <blockquote><p>按Vue的写法在页面定义好一些数据跟指令，引入了两个JS文件。先实例化一个MVue的对象，传入我们的el，data，methods这些参数。待会再看Mvue.js文件是什么？</p></blockquote> <p>html</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>{{person.name}} --- {{person.age}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>{{person.fav}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>{{person.a.b}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>{{msg}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>msg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>person.fav<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-html</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>htmlStr<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>msg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">v-on:</span>click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>click111<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>按钮on<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>click111<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>按钮@<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>./MVue.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>./Observer.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">let</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MVue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      el<span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token punctuation">{</span>
        person<span class="token operator">:</span> <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'星哥'</span><span class="token punctuation">,</span>
          age<span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
          fav<span class="token operator">:</span> <span class="token string">'姑娘'</span><span class="token punctuation">,</span>
          a<span class="token operator">:</span> <span class="token punctuation">{</span>
            b<span class="token operator">:</span> <span class="token string">'787878'</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        msg<span class="token operator">:</span> <span class="token string">'学习MVVM实现原理'</span><span class="token punctuation">,</span>
        htmlStr<span class="token operator">:</span> <span class="token string">'&lt;h4&gt;大家学的怎么样&lt;/h4&gt;'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      methods<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">click111</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>person<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'学习MVVM'</span>
          <span class="token comment">// this.$data.person.name = '学习MVVM'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_2、实现解析器和观察者"><a href="#_2、实现解析器和观察者" class="header-anchor">#</a> 2、实现解析器和观察者</h3> <p>MVue.js</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 先创建一个MVue类,它是一个入口</span>
Class MVue <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>$el <span class="token operator">=</span> options<span class="token punctuation">.</span>el
        <span class="token keyword">this</span><span class="token punctuation">.</span>$data <span class="token operator">=</span> options<span class="token punctuation">.</span>data
        <span class="token keyword">this</span><span class="token punctuation">.</span>$options <span class="token operator">=</span> options
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.实现一个数据的观察者  	--先看解析器，再看Obeserver</span>
        <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$data<span class="token punctuation">)</span>
        <span class="token comment">// 2.实现一个指令解析器</span>
        <span class="token keyword">new</span> <span class="token class-name">Compile</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 定义一个Compile类解析元素节点和指令</span>
<span class="token keyword">class</span> <span class="token class-name">Compile</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span>vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 判断el是否是元素节点对象，不是就通过DOM获取</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>el <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isElementNode</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token operator">?</span> el <span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm
        <span class="token comment">// 1.获取文档碎片对象，放入内存中可以减少页面的回流和重绘</span>
        <span class="token keyword">const</span> fragment <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">node2Fragment</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">)</span>
        
        <span class="token comment">// 2.编辑模板</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span>
        
        <span class="token comment">// 3.追加子元素到根元素(还原页面)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 将元素插入到文档碎片中</span>
    <span class="token function">node2Fragment</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> f <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createDocumnetFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> firstChild
        <span class="token keyword">while</span><span class="token punctuation">(</span>firstChild <span class="token operator">=</span> el<span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        	<span class="token comment">// appendChild </span>
        	<span class="token comment">// 将已经存在的节点再次插入，那么原来位置的节点自动删除，并在新的位置重新插入。</span>
            f<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>firstChild<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 此处执行完，页面已经没有元素节点了</span>
        <span class="token keyword">return</span> f
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 解析模板</span>
    <span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">frafment</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.获取子节点</span>
        conts childNodes <span class="token operator">=</span> fragment<span class="token punctuation">.</span>childNodes<span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token operator">...</span>childNodes<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isElementNode</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 是元素节点</span>
                <span class="token comment">// 编译元素节点</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compileElement</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 文本节点</span>
                <span class="token comment">// 编译文本节点</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compileText</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            
            <span class="token comment">// 嵌套子节点进行遍历解析</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>childNodes <span class="token operator">&amp;&amp;</span> child<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compule</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 判断是元素节点还是属性节点</span>
    <span class="token function">isElementNode</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// nodeType属性返回 以数字值返回指定节点的节点类型。1-元素节点 2-属性节点</span>
        <span class="token keyword">return</span> node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 编译元素节点</span>
    <span class="token function">compileElement</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获得元素属性集合</span>
        <span class="token keyword">const</span> attributes <span class="token operator">=</span> node<span class="token punctuation">.</span>attributes
        <span class="token punctuation">[</span><span class="token operator">...</span>attributes<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">attr</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span>name<span class="token punctuation">,</span> value<span class="token punctuation">}</span> <span class="token operator">=</span> attr
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isDirective</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 判断属性是不是以v-开头的指令</span>
                <span class="token comment">// 解析指令（v-mode v-text v-on:click 等...）</span>
                <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> dirctive<span class="token punctuation">]</span> <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span>
                <span class="token keyword">const</span> <span class="token punctuation">[</span>dirName<span class="token punctuation">,</span> eventName<span class="token punctuation">]</span> <span class="token operator">=</span> dirctive<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>
                <span class="token comment">// 初始化视图 将数据渲染到视图上</span>
                compileUtil<span class="token punctuation">[</span>dirName<span class="token punctuation">]</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span> eventName<span class="token punctuation">)</span>
                
                <span class="token comment">// 删除有指令的标签上的属性</span>
                node<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token string">'v-'</span> <span class="token operator">+</span> dirctive<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isEventName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//判断属性是不是以@开头的指令</span>
                <span class="token comment">// 解析指令</span>
                <span class="token keyword">let</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> eventName<span class="token punctuation">]</span> <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'@'</span><span class="token punctuation">)</span>
                compileUtil<span class="token punctuation">[</span><span class="token string">'on'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span>val<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span> eventName<span class="token punctuation">)</span>
                
                <span class="token comment">// 删除有指令的标签上的属性</span>
        		node<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token string">'@'</span> <span class="token operator">+</span> eventName<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isBindName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//判断属性是不是以:开头的指令</span>
                <span class="token comment">// 解析指令</span>
                <span class="token keyword">let</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> attrName<span class="token punctuation">]</span> <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>
                compileUtil<span class="token punctuation">[</span><span class="token string">'bind'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span>val<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span> attrName<span class="token punctuation">)</span>
                
                <span class="token comment">// 删除有指令的标签上的属性</span>
        		node<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token string">':'</span> <span class="token operator">+</span> attrName<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 编译文本节点</span>
    <span class="token function">compileText</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> content <span class="token operator">=</span> node<span class="token punctuation">.</span>textContent
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex">/\{\{(.+?)\}\}/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            compileUtil<span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> content<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 判断属性是不是指令</span>
    <span class="token function">isDirective</span><span class="token punctuation">(</span><span class="token parameter">attrName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> attrName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'v-'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 判断属性是不是以@开头的事件指令</span>
    <span class="token function">isEventName</span><span class="token punctuation">(</span><span class="token parameter">attrName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> attrName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'@'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 判断属性是不是以:开头的事件指令</span>
    <span class="token function">isBindName</span><span class="token punctuation">(</span><span class="token parameter">attrName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> attrName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">// 定义一个对象，针对不同指令执行不同操作</span>
<span class="token keyword">const</span> compileUtil <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 解析参数(包含嵌套参数解析)，获取其对应的值</span>
    <span class="token function">getVal</span><span class="token punctuation">(</span><span class="token parameter">expre<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> expre<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> currentVal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> data<span class="token punctuation">[</span>currentVal<span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> vm<span class="token punctuation">.</span>$data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 获取当前节点内参数对应的值</span>
    <span class="token function">getgetContentVal</span><span class="token punctuation">(</span><span class="token parameter">expre<span class="token punctuation">,</span>vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> expre<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\{\{(.+?)\}\}/g</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>arges</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVal</span><span class="token punctuation">(</span>arges<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 设置新值</span>
    <span class="token function">setVal</span><span class="token punctuation">(</span><span class="token parameter">expre<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> inputVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> expre<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> currentVal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      		<span class="token keyword">return</span> data<span class="token punctuation">[</span>currentVal<span class="token punctuation">]</span> <span class="token operator">=</span> inputVal
    	<span class="token punctuation">}</span><span class="token punctuation">,</span> vm<span class="token punctuation">.</span>$data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    
    <span class="token comment">// 指令解析：v-test</span>
    <span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> expre<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> value<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>expre<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'{{'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 正则匹配{{}}里的内容</span>
            value <span class="token operator">=</span> expre<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\{\{(.+?)\}\}/g</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>arges</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                
                <span class="token comment">// new watcher这里相关的先可以不看，等后面讲解写到观察者再回头看。这里是绑定观察者实现					 的效果是通过改变数据会触发视图，即数据=》视图。</span>
                <span class="token comment">// 没有new watcher 不影响视图初始化(页面参数的替换渲染)。</span>
                <span class="token comment">// 订阅数据变化，绑定更新函数。</span>
                <span class="token keyword">new</span> <span class="token class-name">watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> arges<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 确保 {{person.name}}----{{person.fav}} 不会因为一个参数变化都被成新值 </span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>updater<span class="token punctuation">.</span><span class="token function">textUpdater</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getgetContentVal</span><span class="token punctuation">(</span>expre<span class="token punctuation">,</span>vm<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVal</span><span class="token punctuation">(</span>arges<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>vm<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 同上，先不看</span>
            <span class="token comment">// 数据=》视图</span>
            <span class="token keyword">new</span> <span class="token class-name">watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expre<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            	<span class="token comment">// 找不到{}说明是test指令，所以当前节点只有一个参数变化，直接用回调函数传入的新值</span>
        		<span class="token keyword">this</span><span class="token punctuation">.</span>updater<span class="token punctuation">.</span><span class="token function">textUpdater</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span>
      		<span class="token punctuation">}</span><span class="token punctuation">)</span>
            
            value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVal</span><span class="token punctuation">(</span>expre<span class="token punctuation">,</span>vm<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 将数据替换，更新到视图上</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>updater<span class="token punctuation">.</span><span class="token function">textUpdater</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//指令解析： v-html</span>
    <span class="token function">html</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> expre<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVal</span><span class="token punctuation">(</span>expre<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
        
        <span class="token comment">// 同上，先不看</span>
        <span class="token comment">// 绑定观察者 数据=》视图</span>
        <span class="token keyword">new</span> <span class="token class-name">watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token function">expre</span> <span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>updater<span class="token punctuation">.</span><span class="token function">htmlUpdater</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        
        <span class="token comment">// 将数据替换，更新到视图上</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>updater<span class="token punctuation">.</span><span class="token function">htmlUpdater</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 指令解析：v-mode</span>
    <span class="token function">model</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span>expre<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVal</span><span class="token punctuation">(</span>expre<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
        
        <span class="token comment">// 同上，先不看</span>
        <span class="token comment">// 绑定观察者 数据=》视图</span>
        <span class="token keyword">new</span> <span class="token class-name">watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expre<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>updater<span class="token punctuation">.</span><span class="token function">modelUpdater</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        
        <span class="token comment">// input框  视图=》数据=》视图</span>
        node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">//设置新值 - 将input值赋值到v-model绑定的参数上</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setVal</span><span class="token punctuation">(</span>expre<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> e<span class="token punctuation">.</span>traget<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// 将数据替换，更新到视图上</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>updater<span class="token punctuation">.</span><span class="token function">modelUpdater</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 指令解析： v-on</span>
    <span class="token function">on</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> expre<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> eventName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 或者指令绑定的事件函数</span>
        <span class="token keyword">let</span> fn <span class="token operator">=</span> vm<span class="token punctuation">.</span>$option<span class="token punctuation">.</span>methods <span class="token operator">&amp;&amp;</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>methods<span class="token punctuation">[</span>expre<span class="token punctuation">]</span>
        <span class="token comment">// 监听函数并调用</span>
        node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span><span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 指令解析： v-bind</span>
    <span class="token function">bind</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> expre<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> attrName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVal</span><span class="token punctuation">(</span>expre<span class="token punctuation">,</span>vm<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>updater<span class="token punctuation">.</span><span class="token function">bindUpdate</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> attrName<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
	<span class="token comment">// updater对象，管理不同指令对应的更新方法</span>
	updater<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// v-text指令对应更新方法</span>
        <span class="token function">textUpdater</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            node<span class="token punctuation">.</span>textContent <span class="token operator">=</span> value
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// v-html指令对应更新方法</span>
        <span class="token function">htmlUpdater</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            node<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> value
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// v-model指令对应更新方法</span>
        <span class="token function">modelUpdater</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span>value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            node<span class="token punctuation">.</span>value <span class="token operator">=</span> value
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// v-bind指令对应更新方法</span>
        <span class="token function">bindUpdate</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> attrName<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            node<span class="token punctuation">[</span>attrName<span class="token punctuation">]</span> <span class="token operator">=</span> value
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3、实现数据劫持监听"><a href="#_3、实现数据劫持监听" class="header-anchor">#</a> 3、实现数据劫持监听</h3> <p><strong>我们有了数据监听，还需要一个观察者可以触发更新视图。因为需要数据改变才能触发更新，所有还需要一个桥梁Dep收集所有观察者(观察者集合)，连接Observer和Watcher。数据改变通知Dep，Dep通知相应的观察者进行视图更新。</strong></p> <p>Observer.js</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 定义一个观察者</span>
<span class="token keyword">class</span> <span class="token class-name">watcher</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> expre<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm
        <span class="token keyword">this</span><span class="token punctuation">.</span>expre <span class="token operator">=</span> expre
        <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span>cb
        <span class="token comment">// 把旧值保存起来</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>oldVal <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOldVal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获取旧值</span>
    <span class="token function">getOldVal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将watcher放到targe值中</span>
        Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span>
        <span class="token comment">// 获取旧值</span>
        <span class="token keyword">const</span> oldVal <span class="token operator">=</span> compileUtil<span class="token punctuation">.</span><span class="token function">getVal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>expre<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">)</span>
        <span class="token comment">// 将target值清空</span>
        Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token keyword">return</span> oldVal
    <span class="token punctuation">}</span>
    <span class="token comment">// 更新函数</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">const</span> newVal <span class="token operator">=</span>  compileUtil<span class="token punctuation">.</span><span class="token function">getVal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>expre<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">)</span>
    	<span class="token keyword">if</span><span class="token punctuation">(</span>newVal <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>oldVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span>
    	<span class="token punctuation">}</span>
  	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">// 定义一个观察者集合</span>
<span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 收集观察者</span>
    <span class="token function">addSub</span><span class="token punctuation">(</span><span class="token parameter">watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//通知观察者去更新</span>
    <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">w</span> <span class="token operator">=&gt;</span> w<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>



<span class="token comment">// 定义一个Observer类通过gettr，setter实现数据的监听绑定</span>
<span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 定义函数解析data,实现数据劫持</span>
    <span class="token function">observer</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>data <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 是对象遍历对象写入getter，setter方法</span>
            Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">defineReactive</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 数据劫持方法</span>
    <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span>key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 递归遍历</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token comment">// 实例化一个dep对象</span>
        <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 通过ES5的API实现数据劫持</span>
        Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            configurable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 当读当前值的时候，会触发。</span>
                <span class="token comment">// 订阅数据变化时，往Dep中添加观察者</span>
                Dep<span class="token punctuation">.</span>target <span class="token operator">&amp;&amp;</span> dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span>
                <span class="token keyword">return</span> value
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">newValue</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// 对新数据进行劫持监听</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observer</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>newValue <span class="token operator">!==</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    value <span class="token operator">=</span> newValue
                <span class="token punctuation">}</span>
                <span class="token comment">// 告诉dep通知变化</span>
        		dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>



</code></pre></div><h2 id="_3、总结"><a href="#_3、总结" class="header-anchor">#</a> 3、总结</h2> <p>其实复杂的地方有三点：</p> <p>1、指令解析的各种操作有点复杂饶人，其中包含DOM的基本操作和一些ES中的API使用。但是你静下心去读去想，肯定是能理顺的。</p> <p>2、数据劫持中Dep的理解，一是收集观察者的集合，二是连接Observer和watcher的桥梁。</p> <p>3、观察者是什么时候进行绑定的？又是如何工作实现了数据驱动视图，视图驱动数据驱动视图的。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/xiaoyu_blog/Language/Node/Reptiles%E7%88%AC%E8%99%AB/" class="prev">
        Reptiles爬虫
      </a></span> <span class="next"><a href="/xiaoyu_blog/Guide/Vue/Vuex/">
        Vuex原理解析
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/xiaoyu_blog/assets/js/app.50625546.js" defer></script><script src="/xiaoyu_blog/assets/js/2.ddd0c7b1.js" defer></script><script src="/xiaoyu_blog/assets/js/10.8de8f570.js" defer></script>
  </body>
</html>
